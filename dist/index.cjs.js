"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});let T,b=[];const w={};function m(){return T}function M(e){T=e}function S(){return b}function h(e){b=e}function D(e){return w[e]}function O(e,t){w[e]=t}let u;const I=async({payload:e,type:t})=>{if(t==="audioTranscriptionMessage"){let n=[];S().forEach(r=>{(r.peerId!==e.peerId||r.peerId===e.peerId&&!r.isPartialTranscript)&&n.push(r)}),n.push(e),n=n.slice(-1*u.noOfTranscriptionsToCache),h(n),u==null||u.transcriptionsCallback(n)}};async function C(e){u=e,e.meeting.participants.on("broadcastedMessage",I)}async function E({meeting:e}){try{e.participants.removeListener("broadcastedMessage",I)}catch(t){console.error("Failed to close bhasa websocket. Error: ",t)}}async function v(e){const t=e.createScriptProcessor(1024,1,1);return t.onaudioprocess=n=>{const r=n.inputBuffer;let i=function(o,f){let d=new Int16Array(o.length/3-f);for(let c=0;c<o.length;c+=3){let a=Math.max(-1,Math.min(1,o[c]));d[c/3]=a<0?a*32768:a*32767}return d},l=r.getChannelData(0);const s=m();if((s==null?void 0:s.readyState)===WebSocket.OPEN){let o=i(l,0);s.send(o.buffer)}},t}async function P({meeting:e,bhasaAccessToken:t,languageCode:n}){k({meeting:e}),e.meta.roomName;const r="ws://216.48.191.199:8000/ws/listen",i=new WebSocket(r);return M(i),i.onmessage=async l=>{var o,f,d,c;const s=JSON.parse(l.data);console.log("data is",s),s.type==="message_response"&&((o=s.messages)==null||o.forEach(a=>{var g,p,y;D((g=a.from)==null?void 0:g.id)===e.self.id&&e.participants.broadcastMessage("audioTranscriptionMessage",{text:a.payload.content,isPartialTranscript:!1,startTimeISO:((p=a.duration)==null?void 0:p.startTime)||new Date().toISOString(),endTimeISO:((y=a.duration)==null?void 0:y.endTime)||new Date().toISOString(),peerId:e.self.id,displayName:e.self.name})})),s.type==="message"&&Object.prototype.hasOwnProperty.call(s.message,"punctuated")&&((f=s.message.user)==null?void 0:f.peerId)===e.self.id&&(O(s.message.user.id,e.self.id),e.participants.broadcastMessage("audioTranscriptionMessage",{text:s.message.punctuated.transcript,isPartialTranscript:!0,startTimeISO:((d=s.message.duration)==null?void 0:d.startTime)||new Date().toISOString(),endTimeISO:((c=s.message.duration)==null?void 0:c.endTime)||new Date().toISOString(),peerId:e.self.id,displayName:e.self.name}))},i.onerror=l=>{console.error("bhasa websocket error: ",l)},i.onclose=()=>{console.info("Connection to bhasa websocket closed")},i.onopen=()=>{i.send(JSON.stringify({event:"config",language:"en-US",timestamp:!0,confidence:!0,api_key:"a1b2c33d4e5f6g7h8i9jakblc",interim_output:!1,profanity:!0,encoding:"LINEAR_PCM"}))},e.self.addAudioMiddleware(v)}async function k({meeting:e}){var t;try{h([]),e.self.removeAudioMiddleware(v),(t=m())==null||t.close()}catch(n){console.error("Failed to close bhasa websocket. Error: ",n)}}async function L(e){var t;if(!((t=e==null?void 0:e.meeting)!=null&&t.self))throw new Error("arguments[0].meeting.self is not available. Did you miss calling new DyteClient first?");if(!(e!=null&&e.bhasaAccessToken))throw new Error("Missing arguments[0].bhasaAccessToken. We need bhasa access token to retrive conversations and to generate transcriptions");return P(e)}async function N(e){var t;if(!((t=e.meeting)!=null&&t.self))throw new Error("arguments[0].meeting.self is not available. Did you miss calling new DyteClient first?");return k(e)}async function x(e){var t;if(!((t=e==null?void 0:e.meeting)!=null&&t.self))throw new Error("arguments[0].meeting.self is not available. Did you miss calling new DyteClient first?");if(!(e!=null&&e.transcriptionsCallback))throw new Error("arguments[0].transcriptionsCallback is not missing. Please provide transcriptionsCallback.");return C(e)}async function _(e){var t;if(!((t=e.meeting)!=null&&t.self))throw new Error("arguments[0].meeting.self is not available. Did you miss calling new DyteClient first?");return E(e)}function A(){return S()}exports.activateTranscriptions=L;exports.addTranscriptionsListerner=x;exports.deactivateTranscriptions=N;exports.getTranscriptions=A;exports.removeTranscriptionsListener=_;
